# Session Context: 46f7d774-300d-42dd-929c-2533662e531b

## Date
2025-11-10

## Objective
Deploy ABsmartly managed component to Cloudflare using the CLI so it can be added to Zaraz.

## Project Overview
- **Project**: ABsmartly Managed Component
- **Purpose**: Flicker-free A/B testing at the edge with ABsmartly
- **Deployment Modes**: Zaraz (Cloudflare) or WebCM (custom infrastructure)
- **Current Status**: Code is ready, needs deployment to Cloudflare

## Actions Taken
1. Created session context file
2. Fixed bundling issues:
   - Removed `isomorphic-dompurify` (was pulling in jsdom with dynamic requires)
   - Replaced with `dompurify` + `linkedom` for HTML sanitization
   - Converted client-script templates from file reads to inline TypeScript modules
   - Cleaned up bundle from 5.9MB to 981KB
3. Configured wrangler.toml with nodejs_compat and proper settings
4. Bundle now builds successfully without Node.js dynamic require errors

## Deployment Process - ✅ COMPLETED

### Custom Worker Wrapper (Replaces managed-component-to-cloudflare-worker tool)
Due to incompatibility with wrangler 4.46, we created a custom deployment infrastructure:

**To deploy:**
```bash
npm run deploy:zaraz
```

This script:
1. Builds the MC bundle (`npm run build`)
2. Copies `dist/index.js` → `worker/src/component.js`
3. Installs worker dependencies
4. Deploys with `wrangler deploy`

**Worker Structure:**
- `worker/src/` - Official wrapper code from cloudflare/managed-component-to-cloudflare-worker
  - `handler.ts` - Request routing for /route, /init, /event endpoints
  - `index.ts` - Worker entry point with fetch handler
  - `models.ts` - TypeScript types
  - `manager.ts`, `client.ts`, `context.ts`, `storage.ts`, `useCache.ts`, `utils.ts` - Core wrapper logic
- `worker/wrangler.toml` - Worker config with KV binding named "KV" (required by wrapper)
- `worker/package.json` - Worker dependencies (@managed-components/types, etc.)

**Deployed Worker:**
- URL: `https://custom-mc-absmartly.absmartly.workers.dev`
- Latest Version ID: `d3063706-4235-4d06-b99d-97a2bbd95c62`
- KV Namespace: `7f37a1bda722439cb7682e30e3a3b572` (binding name: "KV")
- Bundle size: 992.69 KiB (gzip: 260.64 KiB)
- Worker Startup Time: 29 ms

**Why KV is needed:**
- Caches ABsmartly context data (experiment assignments) per user
- Reduces API calls to ABsmartly (improves performance)
- TTL-based expiration for cache cleanup
- See `src/core/context-manager.ts:478` for usage

## After Deployment
1. Go to Cloudflare Dashboard → Zaraz → Third-party tools
2. Click "Add new tool" → "Custom Managed Component"
3. Select `custom-mc-absmartly` worker
4. Configure settings (API key, endpoint, environment, application)
5. Grant permissions
6. Add triggers

## Technical Details - RESOLVED
- **BOTH Zaraz and WebCM modes use linkedom** for server-side HTML processing
- linkedom is used for: Treatment tags processing + Visual Editor DOM changes
- **nodejs_compat IS required** in wrangler.toml for linkedom
- ✅ Replaced isomorphic-dompurify with dompurify + linkedom (removed jsdom dependency)
- ✅ Converted file-based templates to inline TypeScript modules
- ✅ Bundle reduced from 5.9MB to 981KB
- ✅ No more dynamic require errors
- ✅ Build succeeds with proper Worker format

## Files Created/Modified

### Component Bundle Fixes
- `src/utils/dom-sanitization.ts` - Now uses dompurify with linkedom window (fixed TypeScript warning)
- `src/shared/client-scripts/trigger-on-view.ts` - Template as const export
- `src/shared/client-scripts/init.ts` - Template as const export
- `src/shared/client-bundle-generator.ts` - Import templates instead of fs.readFileSync
- `esbuild.js` - Build with platform: node, external: ['node:*']
- `package.json` - Removed isomorphic-dompurify, added dompurify; updated deploy:zaraz script
- `tsconfig.build.json` - Exclude worker/** from typecheck
- `.gitignore` - Ignore worker/src/component.js (auto-generated)
- `DEPLOY_INSTRUCTIONS.md` - Updated with new deployment process
- `deploy.sh` - Simplified deployment script

### Custom Worker Wrapper (NEW)
- `worker/src/handler.ts` - Copied from official wrapper repo
- `worker/src/index.ts` - Copied from official wrapper repo
- `worker/src/models.ts` - Copied from official wrapper repo
- `worker/src/manager.ts` - Copied from official wrapper repo
- `worker/src/client.ts` - Copied from official wrapper repo
- `worker/src/context.ts` - Copied from official wrapper repo
- `worker/src/storage.ts` - Copied from official wrapper repo
- `worker/src/useCache.ts` - Copied from official wrapper repo
- `worker/src/utils.ts` - Copied from official wrapper repo
- `worker/wrangler.toml` - Worker config with KV binding "KV"
- `worker/package.json` - Worker dependencies
- `worker/tsconfig.json` - Worker TypeScript config

### Removed (from root)
- `wrangler.toml` - Deleted (MCs shouldn't have this, only the worker wrapper needs it)

## Summary

✅ **Deployment Successfully Completed**

The ABsmartly Managed Component is now deployed to Cloudflare Workers and ready to be added to Zaraz.

**Key Achievements:**
1. Fixed all Node.js compatibility issues (removed jsdom, converted file-based templates)
2. Created custom Worker wrapper that works with modern wrangler (4.46+)
3. Reduced bundle size from 5.9MB to 981KB
4. Deployed Worker with KV namespace for context caching
5. Zero TypeScript errors or warnings
6. Simple `npm run deploy:zaraz` command for future deployments

**Worker is live at:** https://custom-mc-absmartly.absmartly.workers.dev

**Next step:** Add to Zaraz in Cloudflare Dashboard
